<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ—…ã®ã—ãŠã‚Šãƒ¡ãƒ¼ã‚«ãƒ¼ v3.0</title>
    <meta name="robots" content="noindex, nofollow">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lz-string/1.4.4/lz-string.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; color: #1f2937; }
        
        /* ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ç·š */
        .timeline-line { position: absolute; left: 11px; top: 20px; bottom: -20px; width: 2px; background-color: #e5e7eb; z-index: 0; }
        .timeline-item:last-child .timeline-line { display: none; }
        
        /* ãƒ‰ãƒƒãƒˆ (ä½ç½®èª¿æ•´æ¸ˆã¿) */
        .timeline-dot { 
            position: absolute; left: 0; top: 4px; /* ä½ç½®èª¿æ•´ */
            width: 24px; height: 24px; border-radius: 50%; 
            display: flex; align-items: center; justify-content: center; 
            font-size: 10px; z-index: 10; background-color: #fff; border: 2px solid #94a3b8;
        }
        
        /* ç·¨é›†ãƒ¢ãƒ¼ãƒ‰: ç©´åŸ‹ã‚ã‚¹ã‚¿ã‚¤ãƒ« */
        .input-hole {
            display: inline-block;
            border-bottom: 2px dashed #6366f1;
            color: #4f46e5;
            padding: 0 4px;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: bold;
            min-width: 40px;
            text-align: center;
        }
        .input-hole:hover { background-color: #eef2ff; border-bottom-style: solid; }
        .input-hole.filled { border-bottom: none; color: #1f2937; pointer-events: auto; text-align: left;} 
        .input-hole.filled:hover { color: #4f46e5; }
        .input-readonly { color: #1f2937; border-bottom: none; pointer-events: none; }

        /* ç·¨é›†ãƒ¢ãƒ¼ãƒ‰: é¸æŠãƒœãƒƒã‚¯ã‚¹é¢¨ */
        .select-box {
            display: inline-flex; align-items: center; justify-content: center;
            border: 1px solid #cbd5e1; background-color: #fff;
            padding: 2px 8px; border-radius: 4px; cursor: pointer;
            font-size: 0.75rem; color: #64748b;
        }
        .select-box:hover { border-color: #6366f1; color: #4f46e5; }

        .modal-bg { background-color: rgba(0,0,0,0.5); }
        .no-print { display: block; }
        @media print { .no-print { display: none; } }
    </style>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAOStiNglNEGEnPnhDxJG0RSQqgJXVtUQw&libraries=places,geometry&callback=initMap" async defer></script>
</head>
<body class="pb-20 flex flex-col items-center min-h-screen">

    <header class="w-full bg-indigo-700 text-white shadow-md sticky top-0 z-40 no-print">
        <div class="max-w-2xl mx-auto px-4 py-3 flex justify-between items-end">
            <div>
                <p class="text-[10px] text-indigo-200 font-bold mb-0.5">è¤‡æ•°å€‹æ‰€å·¡ã‚Šãƒ—ãƒ©ãƒ³ç°¡å˜ä½œæˆ</p>
                <h1 class="text-lg font-extrabold flex items-center gap-2 cursor-pointer" onclick="goHome()">
                    <span>ğŸ“–</span> æ—…ã®ã—ãŠã‚Šãƒ¡ãƒ¼ã‚«ãƒ¼ <span class="text-[10px] bg-indigo-500 px-1.5 py-0.5 rounded">v3.0</span>
                </h1>
            </div>
            <button onclick="goHome()" class="text-xs bg-indigo-600 hover:bg-indigo-500 px-3 py-1.5 rounded text-white font-bold transition">
                ğŸ  ãƒã‚¤ãƒšãƒ¼ã‚¸
            </button>
        </div>
    </header>

    <main id="app-content" class="w-full max-w-2xl p-2 sm:p-4"></main>

    <div id="modal-location" class="hidden fixed inset-0 modal-bg z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-sm p-6">
            <h3 class="text-lg font-bold mb-4">ğŸ“ åœ°ç‚¹ãƒ»æ–½è¨­åã®å…¥åŠ›</h3>
            <div class="flex gap-2 mb-2">
                <input type="text" id="input-loc-name" list="saved-locations-list" class="flex-1 p-2 border rounded font-bold" placeholder="ä¾‹: æ±äº¬é§…">
                <button onclick="validateLocation()" class="bg-indigo-100 text-indigo-700 px-3 rounded font-bold whitespace-nowrap">ç¢ºå®š</button>
            </div>
            <p id="loc-search-res" class="text-xs text-gray-500 mb-4 h-4 truncate">â€»ç¢ºå®šã‚’æŠ¼ã—ã¦ä½æ‰€ã‚’ç¢ºèªã—ã¦ãã ã•ã„</p>
            <div class="flex justify-between items-center pt-2 border-t mt-2">
                <button onclick="saveToDictionary()" class="text-xs text-gray-500 hover:text-indigo-600">ğŸ’¾ è¾æ›¸ã«ä¿å­˜</button>
                <div class="flex gap-2">
                    <button onclick="closeModal('modal-location')" class="px-4 py-2 text-gray-500">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                    <button onclick="confirmLocation()" class="px-6 py-2 bg-indigo-600 text-white font-bold rounded shadow">OK</button>
                </div>
            </div>
        </div>
    </div>

    <div id="modal-transport" class="hidden fixed inset-0 modal-bg z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-sm p-6">
            <h3 class="text-lg font-bold mb-4">ğŸš— ç§»å‹•æ‰‹æ®µã®é¸æŠ</h3>
            <select id="input-transport" class="w-full p-3 border rounded text-lg font-bold mb-6">
                <option value="DRIVING_TOLL">ğŸï¸ è»Šï¼ˆæœ‰æ–™å„ªå…ˆï¼‰</option>
                <option value="DRIVING_FREE">ğŸš™ è»Šï¼ˆç„¡æ–™å„ªå…ˆï¼‰</option>
                <option value="WALKING">ğŸš¶ å¾’æ­©</option>
                <option value="BICYCLING">ğŸš² è‡ªè»¢è»Š</option>
            </select>
            <div class="flex justify-end gap-2">
                <button onclick="closeModal('modal-transport')" class="px-4 py-2 text-gray-500">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button onclick="confirmTransport()" class="px-6 py-2 bg-indigo-600 text-white font-bold rounded shadow">OK</button>
            </div>
        </div>
    </div>

    <div id="modal-stay" class="hidden fixed inset-0 modal-bg z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-sm p-6">
            <h3 class="text-lg font-bold mb-4">â³ æ»åœ¨ãƒ»åŸºç‚¹è¨­å®š</h3>
            <div class="mb-3">
                <label class="block text-xs font-bold text-gray-500">æ»åœ¨ç†ç”±</label>
                <input type="text" id="input-stay-reason" class="w-full p-2 border rounded font-bold" placeholder="ä¾‹: æ˜¼é£Ÿ">
            </div>
            <div class="mb-3">
                <label class="block text-xs font-bold text-gray-500">æ»åœ¨æ™‚é–“</label>
                <select id="input-stay-time" class="w-full p-2 border rounded font-bold">
                    <option value="0">0åˆ† (é€šé)</option>
                    <option value="10">10åˆ†</option><option value="20">20åˆ†</option><option value="30">30åˆ†</option>
                    <option value="40">40åˆ†</option><option value="50">50åˆ†</option><option value="60">60åˆ†</option>
                    <option value="90">90åˆ†</option><option value="120">2æ™‚é–“</option><option value="180">3æ™‚é–“</option>
                    <option value="240">4æ™‚é–“</option><option value="300">5æ™‚é–“</option><option value="360">6æ™‚é–“</option>
                </select>
            </div>
            <div class="mb-4 bg-red-50 p-3 rounded border border-red-100">
                <label class="flex items-center gap-2 cursor-pointer">
                    <input type="checkbox" id="input-is-base" class="w-5 h-5 text-red-600 accent-red-600">
                    <span class="font-bold text-sm text-red-800">â˜… ã“ã“ã‚’æ™‚é–“ã®åŸºç‚¹ã«ã™ã‚‹</span>
                </label>
                <p class="text-xs text-red-400 mt-1 pl-7">é›†åˆæ™‚é–“ã‚„äºˆç´„æ™‚é–“ãªã©ã€ç¢ºå®šã—ã¦ã„ã‚‹æ™‚é–“ã«ãƒã‚§ãƒƒã‚¯</p>
            </div>
            <div class="flex justify-end gap-2">
                <button onclick="closeModal('modal-stay')" class="px-4 py-2 text-gray-500">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button onclick="confirmStay()" class="px-6 py-2 bg-indigo-600 text-white font-bold rounded shadow">OK</button>
            </div>
        </div>
    </div>

    <div id="modal-memo" class="hidden fixed inset-0 modal-bg z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-sm p-6">
            <h3 class="text-lg font-bold mb-4">ğŸ“ ãƒ¡ãƒ¢å…¥åŠ›</h3>
            <textarea id="input-memo" rows="3" class="w-full p-3 border rounded mb-4" placeholder="ãƒ¡ãƒ¢ã‚’å…¥åŠ›..."></textarea>
            <div class="flex justify-end gap-2">
                <button onclick="closeModal('modal-memo')" class="px-4 py-2 text-gray-500">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button onclick="confirmMemo()" class="px-6 py-2 bg-indigo-600 text-white font-bold rounded shadow">OK</button>
            </div>
        </div>
    </div>

    <div id="modal-finalize" class="hidden fixed inset-0 modal-bg z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-sm p-6">
            <h3 class="text-lg font-bold mb-4 text-indigo-700">ğŸš€ ä»•ä¸Šã’è¨­å®š</h3>
            <div class="mb-3">
                <label class="block text-xs font-bold text-gray-500 mb-1">ãƒ—ãƒ©ãƒ³å</label>
                <input type="text" id="final-plan-name" class="w-full p-2 border rounded font-bold" value="ãƒã‚¤æ—…ç¨‹ãƒ—ãƒ©ãƒ³">
            </div>
            <div class="mb-3">
                <label class="block text-xs font-bold text-gray-500 mb-1">åŸºç‚¹æ—¥æ™‚</label>
                <input type="datetime-local" id="final-base-time" class="w-full p-2 border rounded font-bold">
            </div>
            <div class="mb-4">
                <label class="block text-xs font-bold text-gray-500 mb-1">æ™‚é–“è¡¨ç¤ºåˆ‡ä¸Šï¼ˆ0:07ã‚’0:10ã«ï¼‰</label>
                <select id="final-rounding" class="w-full p-2 border rounded">
                    <option value="0">ãªã— (ãã®ã¾ã¾è¡¨ç¤º)</option>
                    <option value="5">5åˆ†å˜ä½</option>
                    <option value="10">10åˆ†å˜ä½</option>
                </select>
            </div>
            <div class="flex justify-end gap-2">
                <button onclick="closeModal('modal-finalize')" class="px-4 py-2 text-gray-500">æˆ»ã‚‹</button>
                <button onclick="executeCalculation()" class="px-6 py-2 bg-gradient-to-r from-indigo-600 to-purple-600 text-white font-bold rounded shadow">ä½œæˆã™ã‚‹ï¼</button>
            </div>
        </div>
    </div>

    <datalist id="saved-locations-list"></datalist>

    <script>
        function initMap() { console.log("API Ready"); }
        const APP_VERSION = '3.0';
        
        let mode = 'DASHBOARD'; 
        let savedPlans = JSON.parse(localStorage.getItem('savedPlans_v2')) || [];
        let savedLocations = JSON.parse(localStorage.getItem('savedLocations_v2')) || [];
        let editingPlan = null;
        let editingIndex = -1; 
        let tempLocationData = null; 

        window.onload = () => {
            updateDatalist();
            checkUrlImport();
            if(mode === 'DASHBOARD') renderDashboard();
        };

        // --- ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ (åƒè‘‰ã®ãƒ€ãƒ å·¡ã‚Š - å®Œå…¨ä¿®æ­£ç‰ˆ) ---
        function getSampleData() {
            // åŸºç‚¹ã‚’ã€Œæ˜¼é£Ÿ 12:00ã€ã¨ã™ã‚‹
            const date = new Date(); date.setDate(date.getDate()+1);
            const ymd = date.toISOString().split('T')[0];
            return {
                id: 'sample', name: 'åƒè‘‰ã®ãƒ€ãƒ å·¡ã‚Š', baseTime: `${ymd}T12:00`, rounding: 0,
                stops: [
                    // Index 0: é›†åˆ (Start - Move - Stopã®æ§‹é€ ã§ã¯ãªã„ç‰¹æ®Šãªé–‹å§‹ç‚¹)
                    { type:'STOP', name:'æµ·ã»ãŸã‚‹SA', location:'æµ·ã»ãŸã‚‹PA', confirmed:true, stayTime:0, stayReason:'é›†åˆ', memo:'', isBase:false, timeStr:'07:40' },
                    // Index 1: Move (ãƒ€ãƒŸãƒ¼ç§»å‹• 20åˆ†å¾…æ©Ÿ) -> å®Ÿéš›ã«ã¯ã€Œé›†åˆã€ã‹ã‚‰ã€Œå‡ºç™ºã€ã¾ã§ã®æ™‚é–“
                    { type:'MOVE', mode:'WAIT', duration:0, dist:0 }, 
                    // Index 2: å‡ºç™ºåœ°
                    { type:'STOP', name:'æµ·ã»ãŸã‚‹SA', location:'æµ·ã»ãŸã‚‹PA', confirmed:true, stayTime:0, stayReason:'', memo:'', isBase:false, timeStr:'08:00', depTimeStr:'08:00' },
                    
                    // è¡Œç¨‹é–‹å§‹
                    { type:'MOVE', mode:'DRIVING_TOLL', duration:44, dist:0, roads:['æ±äº¬æ¹¾ã‚¢ã‚¯ã‚¢ãƒ©ã‚¤ãƒ³','é¤¨å±±è‡ªå‹•è»Šé“'] },
                    { type:'STOP', name:'çŸ¢é‚£å·ãƒ€ãƒ  å±•æœ›å°', location:'çŸ¢é‚£å·ãƒ€ãƒ ', confirmed:true, stayTime:20, stayReason:'çŸ¢é‚£å·ãƒ€ãƒ æ’®å½±', memo:'', isBase:false, timeStr:'08:50', depTimeStr:'09:10' },
                    
                    { type:'MOVE', mode:'DRIVING_FREE', duration:49, dist:0 },
                    { type:'STOP', name:'é•·æŸ„ç”ºéƒ½å¸‚è¾²æ‘äº¤æµã‚»ãƒ³ã‚¿ãƒ¼', location:'é•·æŸ„ç”ºéƒ½å¸‚è¾²æ‘äº¤æµã‚»ãƒ³ã‚¿ãƒ¼', confirmed:true, stayTime:20, stayReason:'é•·æŸ„ãƒ€ãƒ æ’®å½±', memo:'ã‚«ãƒ¼ãƒ‰å–å¾—', isBase:false, timeStr:'10:00', depTimeStr:'10:20' },
                    
                    { type:'MOVE', mode:'DRIVING_FREE', duration:27, dist:0 },
                    { type:'STOP', name:'é«˜æ»ãƒ€ãƒ è¨˜å¿µé¤¨', location:'é«˜æ»ãƒ€ãƒ è¨˜å¿µé¤¨', confirmed:true, stayTime:20, stayReason:'é«˜æ»ãƒ€ãƒ æ’®å½±', memo:'ã‚«ãƒ¼ãƒ‰å–å¾—', isBase:false, timeStr:'10:50', depTimeStr:'11:10' },
                    
                    { type:'MOVE', mode:'DRIVING_FREE', duration:50, dist:0 },
                    { type:'STOP', name:'å‰²çƒ¹æ–™ç†ã€Œå¤©å¹³ã€', location:'å‰²çƒ¹æ–™ç†å¤©å¹³', confirmed:true, stayTime:60, stayReason:'æ˜¼é£Ÿ', memo:'ãªã‚ã‚ã†ã¨ã•ã‚“ãŒç„¼ããŒãŠè–¦ã‚', isBase:true, timeStr:'12:00', depTimeStr:'13:00' },
                    
                    { type:'MOVE', mode:'DRIVING_FREE', duration:51, dist:0 },
                    { type:'STOP', name:'ç‰‡å€‰ãƒ€ãƒ ', location:'ç‰‡å€‰ãƒ€ãƒ ', confirmed:true, stayTime:10, stayReason:'ç‰‡å€‰ãƒ€ãƒ æ’®å½±', memo:'', isBase:false, timeStr:'14:00', depTimeStr:'14:10' },
                    
                    { type:'MOVE', mode:'DRIVING_FREE', duration:10, dist:0 },
                    { type:'STOP', name:'äº€å±±ãƒ»ç‰‡å€‰ãƒ€ãƒ ç®¡ç†äº‹å‹™æ‰€', location:'äº€å±±ãƒ»ç‰‡å€‰ãƒ€ãƒ ç®¡ç†äº‹å‹™æ‰€', confirmed:true, stayTime:20, stayReason:'äº€å±±ãƒ€ãƒ æ’®å½±', memo:'äº€å±±ãƒ»ç‰‡å€‰ãƒ»çŸ¢é‚£å·ãƒ€ãƒ ã‚«ãƒ¼ãƒ‰å–å¾—', isBase:false, timeStr:'14:20', depTimeStr:'14:40' },
                    
                    { type:'MOVE', mode:'DRIVING_TOLL', duration:44, dist:0, roads:['é¤¨å±±è‡ªå‹•è»Šé“','æ±äº¬æ¹¾ã‚¢ã‚¯ã‚¢ãƒ©ã‚¤ãƒ³'] },
                    { type:'STOP', name:'æµ·ã»ãŸã‚‹SA', location:'æµ·ã»ãŸã‚‹PA', confirmed:true, stayTime:0, stayReason:'', memo:'', isBase:false, timeStr:'15:30', depTimeStr:'' }
                ]
            };
        }

        // --- ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚° ---
        function renderDashboard() {
            mode = 'DASHBOARD';
            let listHtml = '';
            if (savedPlans.length > 0) {
                savedPlans.forEach((p, i) => {
                    listHtml += `
                    <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-200 mb-4 flex justify-between items-center">
                        <div>
                            <div class="font-bold text-lg text-indigo-900">${p.name}</div>
                            <div class="text-xs text-gray-500">${new Date(p.updatedAt).toLocaleDateString()} æ›´æ–°</div>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="sharePlan(${i})" class="text-xs bg-gray-100 px-3 py-1.5 rounded hover:bg-gray-200">ğŸ”—</button>
                            <button onclick="deletePlan(${i})" class="text-xs bg-red-50 text-red-500 px-3 py-1.5 rounded hover:bg-red-100">å‰Šé™¤</button>
                            <button onclick="openPlan(${i})" class="text-sm bg-indigo-600 text-white px-4 py-1.5 rounded font-bold hover:bg-indigo-700">é–‹ã</button>
                        </div>
                    </div>`;
                });
            } else {
                listHtml = `<div class="text-center text-gray-400 py-8">ä¿å­˜ã•ã‚ŒãŸãƒ—ãƒ©ãƒ³ã¯ã‚ã‚Šã¾ã›ã‚“</div>`;
            }

            document.getElementById('app-content').innerHTML = `
                <div class="space-y-8 animate-fade-in">
                    <div class="bg-white rounded-2xl shadow-lg overflow-hidden cursor-pointer hover:shadow-xl transition" onclick="showSample()">
                        <div class="bg-gradient-to-r from-blue-500 to-cyan-500 h-2"></div>
                        <div class="p-6 text-center">
                            <h3 class="text-xl font-extrabold text-gray-800 mb-1">åƒè‘‰ã®ãƒ€ãƒ å·¡ã‚Š</h3>
                            <p class="text-xs text-gray-500 mb-4">ã‚µãƒ³ãƒ—ãƒ«ãƒ—ãƒ©ãƒ³</p>
                            <div class="text-sm text-blue-600 font-bold">ğŸ‘€ è¦‹æœ¬ã‚’è¦‹ã‚‹ / ã“ã‚Œã‚’åŸºã«ä½œæˆ</div>
                        </div>
                    </div>
                    <button onclick="startNewEdit()" class="w-full py-4 bg-gradient-to-r from-indigo-600 to-purple-600 text-white text-lg font-bold rounded-2xl shadow-lg hover:opacity-90 transform transition hover:-translate-y-1">
                        + æ–°ã—ã„æ—…ç¨‹ã‚’ä½œæˆã™ã‚‹
                    </button>
                    <div>
                        <h3 class="font-bold text-gray-700 mb-2 border-l-4 border-indigo-500 pl-2">ğŸ“‚ ãƒã‚¤æ—…ã®ã—ãŠã‚Š</h3>
                        ${listHtml}
                    </div>
                </div>`;
        }

        // ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³æç”» (å…±é€š)
        function renderTimeline() {
            const isEdit = (mode === 'EDIT');
            const isSample = (mode === 'SAMPLE');
            const plan = editingPlan;
            
            let html = `
                <div class="bg-white rounded-3xl shadow-xl overflow-hidden mb-8 min-h-[600px] relative">
                    <div class="p-5 bg-gradient-to-r from-indigo-700 to-blue-700 text-white text-center">
                        <h2 class="text-xl font-extrabold mb-1">${plan.name}</h2>
                        ${isSample ? '<p class="mt-2 text-xs bg-white/20 inline-block px-3 py-1 rounded-full">ã“ã®ã‚µãƒ³ãƒ—ãƒ«ã‚’ã‚ãªãŸã®æ—…ãƒ—ãƒ©ãƒ³ã«ä½œã‚Šæ›¿ãˆã¾ã—ã‚‡ã†</p>' : `<p class="text-xs opacity-80">${new Date().toLocaleDateString()} ä½œæˆ</p>`}
                    </div>
                    <div class="p-4 sm:p-6 pb-24 space-y-0">`; // pb-24 for footer space

            plan.stops.forEach((item, i) => {
                const isFirst = i === 0; // é›†åˆ
                const isStart = i === 2; // å‡ºç™º
                const isLast = i === plan.stops.length - 1;
                
                if (item.type === 'STOP') {
                    // --- 1. åˆ°ç€/é›†åˆ è¡Œ ---
                    const timeDisp = item.timeStr || '00:00';
                    let suffix = 'åˆ°ç€';
                    if (isFirst) suffix = 'é›†åˆ'; 
                    else if (isStart) suffix = 'å‡ºç™º';
                    
                    const dotClass = item.isBase ? 'border-red-500 text-red-500' : 'border-gray-400 text-gray-400';
                    const dotIcon = item.isBase ? 'â˜…' : 'â—';

                    // åœ°ç‚¹åè¡¨ç¤º (Index 0ã¯ç·¨é›†ä¸å¯ã€‚Index 2ã®å…¥åŠ›ã‚’åæ˜ ã™ã‚‹ãŸã‚)
                    let nameHtml = '';
                    if (isEdit) {
                        if (isFirst) {
                            // é›†åˆå ´æ‰€ã¯èª­ã¿å–ã‚Šå°‚ç”¨ï¼ˆå‡ºç™ºåœ°ã¨åŒã˜ï¼‰
                            const val = item.name || 'ï¼ˆå‡ºç™ºåœ°ã¨åŒã˜ï¼‰';
                            nameHtml = `<span class="input-readonly text-gray-500 text-sm">${val}</span>`;
                        } else {
                            const val = item.name || 'åœ°ç‚¹ãƒ»æ–½è¨­åã®å…¥åŠ›';
                            const cls = item.name ? 'input-hole filled' : 'input-hole text-gray-400';
                            nameHtml = `<span onclick="openLocationModal(${i})" class="${cls}">${val}</span>`;
                        }
                    } else {
                        nameHtml = `<span class="font-bold text-gray-800">${item.name}</span>`;
                    }

                    // å‰Šé™¤ãƒ»ç§»å‹•ãƒœã‚¿ãƒ³ (é›†åˆã¨å‡ºç™ºã¯ç§»å‹•ä¸å¯)
                    let controls = '';
                    if (isEdit && i > 2) {
                        controls = `
                        <div class="flex gap-1 ml-2">
                            ${i > 4 ? `<button onclick="moveStop(${i},-1)" class="text-[10px] bg-gray-100 px-1 rounded hover:bg-gray-200">â†‘</button>` : ''}
                            ${!isLast ? `<button onclick="moveStop(${i},1)" class="text-[10px] bg-gray-100 px-1 rounded hover:bg-gray-200">â†“</button>` : ''}
                            <button onclick="deleteStop(${i})" class="text-red-400 text-xs ml-1 font-bold">Ã—</button>
                        </div>`;
                    }

                    // è¡Œã®æç”» (å‡ºç™ºåœ°ã®å ´åˆã¯ã€Œåˆ°ç€ã€ã¨ã¯è¨€ã‚ãšã€ãã®ã¾ã¾å‡ºç™ºæ™‚é–“ã‚’è¡¨ç¤ºã™ã‚‹ã®ã§ã“ã®è¡Œã¯ã‚¹ã‚­ãƒƒãƒ—ã—ãŸã„ãŒã€
                    // ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆä¸Šã€Œé›†åˆã€â†’ã€Œï¼ˆç©ºãï¼‰ã€â†’ã€Œå‡ºç™ºã€ã¨ãªã‚‹ã€‚
                    // Index 2 (Start) ã®å ´åˆã€suffixã‚’ç©ºã«ã—ã¦ã€æ™‚é–“ã‚’depTimeStrã®ã¿ã«ã™ã‚‹æ‰‹ã‚‚ã‚ã‚‹ãŒã€
                    // è¦æœ›ã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã€Œâ— 08:00 æµ·ã»ãŸã‚‹ å‡ºç™ºã€ã«åˆã‚ã›ã‚‹ã€‚
                    
                    if (isStart) {
                         // Index 2 ã¯ã€Œå‡ºç™ºã€å°‚ç”¨è¡Œã¨ã—ã¦æ‰±ã†
                         html += `
                        <div class="relative pl-8 pb-3 min-h-[30px]">
                            <div class="timeline-line"></div>
                            <div class="timeline-dot ${dotClass}">${dotIcon}</div>
                            <div class="flex items-center gap-2">
                                <div class="w-10 text-right font-bold text-sm text-gray-800 flex-shrink-0">${item.timeStr}</div> <div class="flex-grow text-sm">${nameHtml} <span class="font-bold text-gray-600">å‡ºç™º</span></div>
                            </div>
                        </div>`;
                    } else {
                        // é€šå¸¸ã®åˆ°ç€ãƒ»é›†åˆè¡Œ
                        html += `
                        <div class="relative pl-8 pb-3 min-h-[30px]">
                            <div class="timeline-line"></div>
                            <div class="timeline-dot ${dotClass}">${dotIcon}</div>
                            <div class="flex items-center gap-2">
                                <div class="w-10 text-right font-bold text-sm text-gray-800 flex-shrink-0">${timeDisp}</div>
                                <div class="flex-grow text-sm flex items-center">${nameHtml} <span class="font-bold text-gray-600 ml-1">${suffix}</span>${controls}</div>
                            </div>
                        </div>`;
                    }

                    // --- 2. æ»åœ¨æƒ…å ± (é›†åˆãƒ»å‡ºç™ºãƒ»æœ€çµ‚ä»¥å¤–) ---
                    if (!isFirst && !isStart && !isLast) {
                        let stayHtml = '';
                        if (isEdit) {
                            const rVal = item.stayReason || 'æ»åœ¨ç†ç”±';
                            const tVal = item.stayTime || '00';
                            stayHtml = `
                                <div class="flex items-center gap-2 text-sm text-gray-600 mt-1">
                                    <span class="text-xl">â³</span>
                                    <span onclick="openStayModal(${i})" class="input-hole ${item.stayReason?'filled':'text-gray-400'}">${rVal}</span> æ»åœ¨ 
                                    <span onclick="openStayModal(${i})" class="input-hole ${item.stayTime?'filled':'text-gray-400'}">${tVal}</span> åˆ†
                                    <span onclick="openMemoModal(${i})" class="input-hole ${item.memo?'filled':'text-gray-400'} text-xs ml-2">${item.memo||'ğŸ“ ãƒ¡ãƒ¢å…¥åŠ›'}</span>
                                </div>`;
                        } else {
                            if (item.stayReason || item.stayTime > 0) {
                                stayHtml = `
                                <div class="flex gap-2 mt-1">
                                    <div class="w-10 flex-shrink-0 text-center text-xl">â³</div>
                                    <div>
                                        <div class="text-sm text-gray-800 font-bold">
                                            ${item.stayReason} <span class="text-gray-500 font-normal ml-2">æ»åœ¨ ${item.stayTime}åˆ†</span>
                                        </div>
                                        ${item.memo ? `<div class="text-xs text-gray-500 mt-0.5">ğŸ“ ${item.memo}</div>` : ''}
                                    </div>
                                </div>`;
                            }
                        }
                        
                        if (stayHtml) {
                            html += `<div class="relative pl-8 pb-2"><div class="timeline-line"></div>${stayHtml}</div>`;
                        }

                        // --- 3. å‡ºç™º è¡Œ (è‡ªå‹•æŒ¿å…¥) ---
                        // ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã§ã‚‚ã€Œå‡ºç™ºã€è¡Œã‚’è¦‹ã›ã‚‹
                        const depTime = item.depTimeStr || '00:00'; 
                        let depNameHtml = isEdit ? `<span class="text-gray-400">${item.name||'åœ°ç‚¹å'}</span>` : `<span class="font-bold text-gray-800">${item.name}</span>`;

                        html += `
                        <div class="relative pl-8 pb-3 min-h-[30px]">
                            <div class="timeline-line"></div>
                            <div class="timeline-dot border-gray-400 text-gray-400">â—</div>
                            <div class="flex items-center gap-2">
                                <div class="w-10 text-right font-bold text-sm text-gray-800 flex-shrink-0">${depTime}</div>
                                <div class="flex-grow text-sm">${depNameHtml} <span class="font-bold text-gray-600">å‡ºç™º</span></div>
                            </div>
                        </div>`;
                    }

                } else if (item.type === 'MOVE') {
                    // --- ç§»å‹• è¡Œ ---
                    if (item.mode === 'WAIT') return; // Index 1ã®ãƒ€ãƒŸãƒ¼ã¯ã‚¹ã‚­ãƒƒãƒ—

                    const mKey = item.mode;
                    const modeLabels = { 'DRIVING_FREE':'è»Š', 'DRIVING_TOLL':'è»Š(æœ‰æ–™)', 'WALKING':'å¾’æ­©', 'BICYCLING':'è‡ªè»¢è»Š' };
                    const icon = { 'DRIVING_FREE':'ğŸš—', 'DRIVING_TOLL':'ğŸš—', 'WALKING':'ğŸš¶', 'BICYCLING':'ğŸš²' }[mKey] || 'ğŸš—';
                    const dur = item.duration ? `${item.duration}åˆ†` : '00åˆ†';
                    
                    let moveContent = '';
                    if (isEdit) {
                        moveContent = `
                        <div class="flex items-center gap-2 text-sm pl-12">
                            <span onclick="openTransportModal(${i})" class="select-box">${icon} ${modeLabels[mKey]} â–¼</span>
                            <span class="text-gray-400">ç§»å‹• ${dur}</span>
                        </div>`;
                    } else {
                        let roads = '';
                        if (item.roads && item.roads.length > 0) {
                            roads = `<div class="text-xs text-gray-500 ml-1 leading-tight">${item.roads.join('<br>')}</div>`;
                        }
                        // ãƒŠãƒ“ãƒœã‚¿ãƒ³ (Sampleã§ã‚‚Editã§ã‚‚ãªã„Resultãƒ¢ãƒ¼ãƒ‰ã€ã‚ã‚‹ã„ã¯Sampleãƒ¢ãƒ¼ãƒ‰ã§ã‚‚è¡¨ç¤ºè¦æœ›ã‚ã‚Š)
                        let navBtn = '';
                        if (plan.stops[i-1] && plan.stops[i+1]) {
                             const origin = encodeURIComponent(plan.stops[i-1].location);
                             const dest = encodeURIComponent(plan.stops[i+1].location);
                             const tmode = (mKey.includes('DRIVING')) ? 'driving' : (mKey==='WALKING'?'walking':'bicycling');
                             const url = `https://www.google.com/maps/dir/?api=1&origin=${origin}&destination=${dest}&travelmode=${tmode}`;
                             navBtn = `<a href="${url}" target="_blank" class="ml-2 text-[10px] bg-blue-50 text-blue-600 border border-blue-200 px-2 py-0.5 rounded hover:bg-blue-100 no-print flex items-center gap-1 w-fit">ğŸ§­ ãƒŠãƒ“</a>`;
                        }
                        
                        moveContent = `
                        <div class="flex gap-2 pl-12">
                            <div class="text-sm font-bold text-gray-600 flex items-center flex-wrap">
                                ${icon} ${modeLabels[mKey]}ç§»å‹• <span class="text-gray-800 font-normal ml-1">${dur}</span>
                            </div>
                            ${roads}
                        </div>
                        <div class="pl-12 mt-1">${navBtn}</div>`;
                    }

                    html += `
                    <div class="relative pb-3">
                        <div class="timeline-line"></div>
                        ${moveContent}
                    </div>`;
                }
            });

            // ãƒ•ãƒƒã‚¿ãƒ¼ (ãƒœã‚¿ãƒ³é¡)
            let footer = '';
            if (isSample) {
                footer = `<div class="mt-8 text-center pb-8"><button onclick="copySampleToEdit()" class="w-full py-4 bg-gradient-to-r from-pink-500 to-rose-500 text-white text-xl font-extrabold rounded-2xl shadow-xl hover:scale-105 transition transform">âœ¨ æ–°ã—ããƒã‚¤ã€Œæ—…ã®ã—ãŠã‚Šã€ã‚’ã¤ãã‚‹</button></div>`;
            } else if (isEdit) {
                // ç·¨é›†ç”»é¢ã«ã‚‚ãƒœã‚¿ãƒ³ã‚’è¨­ç½®
                footer = `
                <div class="mt-8 space-y-4 text-center pb-8">
                    <button onclick="addNextStop()" class="w-full py-3 border-2 border-dashed border-gray-300 text-gray-400 font-bold rounded-xl hover:border-indigo-500 hover:text-indigo-500 transition">+ åœ°ç‚¹ã‚’è¿½åŠ </button>
                    <button onclick="openFinalizeModal()" class="w-full py-4 bg-gradient-to-r from-indigo-600 to-purple-600 text-white text-xl font-extrabold rounded-2xl shadow-xl hover:opacity-90 transition">âœ¨ æ—…ã®ã—ãŠã‚Šã‚’ã¤ãã‚‹</button>
                </div>`;
            } else { // RESULT
                footer = `
                <div class="mt-8 no-print space-y-4 pb-8">
                    <div class="bg-gray-100 rounded-xl h-64 w-full border border-gray-200" id="full-map-area"></div>
                    <div class="flex gap-2">
                        <button onclick="mode='EDIT'; renderTimeline();" class="flex-1 bg-gray-200 text-gray-700 font-bold py-3 rounded-xl">ä¿®æ­£ã™ã‚‹</button>
                        <button onclick="saveCurrentPlan()" class="flex-1 bg-indigo-600 text-white font-bold py-3 rounded-xl">ä¿å­˜ã™ã‚‹</button>
                    </div>
                </div>`;
            }

            document.getElementById('app-content').innerHTML = html + footer + `</div></div>`;
            
            if(!isEdit && !isSample) setTimeout(initFullMap, 500); 
        }

        // --- 3. ãƒ­ã‚¸ãƒƒã‚¯ ---
        function showSample() { editingPlan = getSampleData(); mode = 'SAMPLE'; renderTimeline(); }
        
        function copySampleToEdit() {
            const sample = getSampleData();
            // åå‰ã‚„ç¢ºå®šãƒ•ãƒ©ã‚°ã‚’ã‚¯ãƒªã‚¢ã—ã¦ç·¨é›†ç”¨ãƒ‡ãƒ¼ã‚¿ä½œæˆ
            editingPlan = {
                id: 'plan_' + Date.now(), name: 'æ–°è¦æ—…ç¨‹ãƒ—ãƒ©ãƒ³', baseTime: sample.baseTime, rounding: 0,
                stops: sample.stops.map(s => {
                    if (s.type === 'MOVE') return { ...s, duration: 0, roads:[] };
                    return { ...s, name:'', location:'', confirmed:false, stayTime: s.stayTime, stayReason: s.stayReason, memo: s.memo, timeStr:'00:00', depTimeStr:'00:00' };
                })
            };
            // é›†åˆã¨å‡ºç™ºã®é€£æºã®ãŸã‚ã€åˆæœŸåŒ–
            editingPlan.stops[0].name = 'ï¼ˆå‡ºç™ºåœ°ã¨åŒã˜ï¼‰';
            
            mode = 'EDIT'; renderTimeline();
        }
        function startNewEdit() { copySampleToEdit(); }

        function addNextStop() {
            editingPlan.stops.push({ type:'MOVE', mode:'DRIVING_FREE', duration:0 });
            editingPlan.stops.push({ type:'STOP', name:'', location:'', confirmed:false, stayTime:20, stayReason:'', memo:'', isBase:false, timeStr:'00:00' });
            renderTimeline();
        }
        
        function deleteStop(idx) {
            // Index 0(Meet), 1(Wait), 2(Start) ã¯å‰Šé™¤ä¸å¯
            if(idx <= 2 || idx === editingPlan.stops.length-1) { alert('ã“ã®åœ°ç‚¹ã¯å‰Šé™¤ã§ãã¾ã›ã‚“'); return; }
            editingPlan.stops.splice(idx-1, 2); // å‰ã®Moveã¨è‡ªåˆ†ã‚’å‰Šé™¤
            renderTimeline();
        }

        // ä¸¦ã³æ›¿ãˆä¿®æ­£ï¼šMoveã¨Stopã‚’ã‚»ãƒƒãƒˆã§å‹•ã‹ã™
        function moveStop(idx, dir) {
            // å‹•ã‹ã›ã‚‹ã®ã¯ Index 4 (æœ€åˆã®ç›®çš„åœ°) ä»¥é™
            if (idx <= 2) return; 

            // idx ã¯ STOP ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã€‚ æ‰‹å‰ã® MOVE (idx-1) ã¨ã‚»ãƒƒãƒˆã§å‹•ã‹ã™ã€‚
            const moveIdx = idx - 1; 

            if (dir === -1) { // Up
                // ä¸€ã¤å‰ãŒ Start(Index 2) ãªã‚‰ç§»å‹•ä¸å¯ (MoveIdxãŒ3ã‚ˆã‚Šå°ã•ã„ã¨ãƒ€ãƒ¡)
                if (moveIdx <= 2) return; 
                
                // [Move(Target-2), Stop(Target-1)] <-> [Move(Self), Stop(Self)]
                const selfSet = editingPlan.stops.splice(moveIdx, 2); 
                editingPlan.stops.splice(moveIdx - 2, 0, ...selfSet);
            } else { // Down
                // å¾Œã‚ãŒãªã„ãªã‚‰æˆ»ã‚‹
                if (idx >= editingPlan.stops.length - 2) return;

                // [Move(Self), Stop(Self)] <-> [Move(Target+1), Stop(Target+1)]
                const selfSet = editingPlan.stops.splice(moveIdx, 2);
                editingPlan.stops.splice(moveIdx + 2, 0, ...selfSet);
            }
            renderTimeline();
        }

        // --- Modal Logic ---
        function openModal(id) { document.getElementById(id).classList.remove('hidden'); }
        function closeModal(id) { document.getElementById(id).classList.add('hidden'); }

        function openLocationModal(idx) {
            editingIndex = idx;
            const item = editingPlan.stops[idx];
            document.getElementById('input-loc-name').value = item.name;
            document.getElementById('loc-search-res').textContent = item.confirmed ? `â€»ç¢ºå®šæ¸ˆ: ${item.location}` : 'â€»ç¢ºå®šã‚’æŠ¼ã—ã¦ä½æ‰€ã‚’ç¢ºèªã—ã¦ãã ã•ã„';
            tempLocationData = item.confirmed ? item.location : null;
            openModal('modal-location');
        }
        function validateLocation() {
            const val = document.getElementById('input-loc-name').value;
            if(!val) return;
            const svc = new google.maps.places.AutocompleteService();
            svc.getPlacePredictions({ input: val }, (preds, status) => {
                const el = document.getElementById('loc-search-res');
                if (status === 'OK' && preds.length > 0) {
                    tempLocationData = preds[0].description;
                    el.innerHTML = `<span class="text-green-600">âœ… OK: ${tempLocationData}</span>`;
                } else {
                    tempLocationData = null;
                    el.innerHTML = `<span class="text-red-500">âŒ è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“</span>`;
                }
            });
        }
        function saveToDictionary() {
            const val = document.getElementById('input-loc-name').value;
            if(val && !savedLocations.includes(val)) {
                savedLocations.push(val);
                localStorage.setItem('savedLocations_v2', JSON.stringify(savedLocations));
                updateDatalist();
                alert('è¾æ›¸ã«ä¿å­˜ã—ã¾ã—ãŸ');
            }
        }
        function confirmLocation() {
            if(!tempLocationData) { alert('ç¢ºå®šã‚’è¡Œã£ã¦ãã ã•ã„'); return; }
            
            // ãƒ‡ãƒ¼ã‚¿ã®æ›´æ–°
            const item = editingPlan.stops[editingIndex];
            item.name = document.getElementById('input-loc-name').value;
            item.location = tempLocationData;
            item.confirmed = true;
            
            // â˜…é‡è¦ï¼šå‡ºç™ºåœ°(Index 2)ã‚’å…¥åŠ›ã—ãŸã‚‰ã€é›†åˆå ´æ‰€(Index 0)ã«ã‚‚ã‚³ãƒ”ãƒ¼ã™ã‚‹
            if (editingIndex === 2) {
                const meet = editingPlan.stops[0];
                meet.name = item.name;
                meet.location = item.location;
                meet.confirmed = true;
            }

            closeModal('modal-location');
            renderTimeline();
        }

        function openTransportModal(idx) {
            editingIndex = idx;
            document.getElementById('input-transport').value = editingPlan.stops[idx].mode;
            openModal('modal-transport');
        }
        function confirmTransport() {
            editingPlan.stops[editingIndex].mode = document.getElementById('input-transport').value;
            closeModal('modal-transport');
            renderTimeline();
        }

        function openStayModal(idx) {
            editingIndex = idx;
            const item = editingPlan.stops[idx];
            document.getElementById('input-stay-reason').value = item.stayReason;
            document.getElementById('input-stay-time').value = item.stayTime;
            document.getElementById('input-is-base').checked = item.isBase;
            openModal('modal-stay');
        }
        function confirmStay() {
            const item = editingPlan.stops[editingIndex];
            item.stayReason = document.getElementById('input-stay-reason').value;
            item.stayTime = parseInt(document.getElementById('input-stay-time').value);
            if(document.getElementById('input-is-base').checked) {
                editingPlan.stops.forEach(s => { if(s.type==='STOP') s.isBase = false; });
                item.isBase = true;
            } else { item.isBase = false; }
            closeModal('modal-stay');
            renderTimeline();
        }

        function openMemoModal(idx) {
            editingIndex = idx;
            document.getElementById('input-memo').value = editingPlan.stops[idx].memo;
            openModal('modal-memo');
        }
        function confirmMemo() {
            editingPlan.stops[editingIndex].memo = document.getElementById('input-memo').value;
            closeModal('modal-memo');
            renderTimeline();
        }

        function openFinalizeModal() {
            const invalid = editingPlan.stops.filter(s => s.type==='STOP' && !s.confirmed && s.name !== 'ï¼ˆå‡ºç™ºåœ°ã¨åŒã˜ï¼‰');
            if(invalid.length > 0) { alert('æœªç¢ºå®šã®åœ°ç‚¹ãŒã‚ã‚Šã¾ã™'); return; }
            const hasBase = editingPlan.stops.some(s => s.type==='STOP' && s.isBase);
            if(!hasBase) { alert('æ™‚é–“ã®åŸºç‚¹ï¼ˆâ˜…ï¼‰ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“'); return; }

            const d = new Date(); d.setDate(d.getDate()+1); d.setHours(8,0,0,0);
            const iso = new Date(d.getTime() - d.getTimezoneOffset()*60000).toISOString().slice(0,16);
            document.getElementById('final-base-time').value = iso;
            openModal('modal-finalize');
        }

        async function executeCalculation() {
            editingPlan.name = document.getElementById('final-plan-name').value;
            editingPlan.baseTime = document.getElementById('final-base-time').value;
            editingPlan.rounding = parseInt(document.getElementById('final-rounding').value);
            
            closeModal('modal-finalize');
            document.getElementById('app-content').innerHTML = '<div class="text-center p-20"><div class="text-3xl animate-bounce">ğŸš—</div><div class="mt-4 font-bold text-gray-500">ãƒ«ãƒ¼ãƒˆè¨ˆç®—ä¸­...</div></div>';

            const ds = new google.maps.DirectionsService();
            for(let i=0; i<editingPlan.stops.length; i++) {
                const item = editingPlan.stops[i];
                if (item.type === 'MOVE') {
                    if (item.mode === 'WAIT') continue; 
                    
                    const start = editingPlan.stops[i-1].location;
                    const end = editingPlan.stops[i+1].location;
                    let gMode = 'DRIVING';
                    let avoidTolls = false;
                    
                    if(item.mode === 'DRIVING_FREE') avoidTolls = true;
                    else if(item.mode === 'DRIVING_TOLL') avoidTolls = false;
                    else gMode = item.mode;

                    try {
                        const res = await new Promise(resolve => {
                            ds.route({ origin: start, destination: end, travelMode: gMode, avoidTolls: avoidTolls }, (r, s) => resolve(s==='OK'?r:null));
                        });
                        if (res) {
                            const leg = res.routes[0].legs[0];
                            item.duration = Math.ceil(leg.duration.value / 60);
                            let roads = [];
                            if (gMode === 'DRIVING') {
                                leg.steps.forEach(s => {
                                    if(s.instructions.includes('æœ‰æ–™') || s.instructions.includes('é«˜é€Ÿ') || s.instructions.includes('æ–™é‡‘')) {
                                        const m = s.instructions.match(/([^\s]+(?:é«˜é€Ÿ|è‡ªå‹•è»Šé“|ãƒ©ã‚¤ãƒ³|ã‚¹ã‚«ã‚¤ã‚¦ã‚§ã‚¤)[^\s]*)/);
                                        if(m) roads.push(m[1]);
                                    }
                                });
                                item.roads = [...new Set(roads)];
                            }
                        } else { item.duration = 0; }
                    } catch(e) { item.duration = 0; }
                }
            }
            calculateSchedule();
            mode = 'RESULT';
            renderTimeline();
        }

        // æ™‚é–“è¨ˆç®—
        function calculateSchedule() {
            const stops = editingPlan.stops;
            const baseIdx = stops.findIndex(s => s.type==='STOP' && s.isBase);
            const round = editingPlan.rounding;
            const addMin = (d, m) => new Date(d.getTime() + m*60000);
            const roundUp = (d) => {
                if(!round) return d;
                const m = d.getMinutes(); const r = m % round;
                return r===0 ? d : addMin(d, round - r);
            };
            const roundDown = (d) => {
                if(!round) return d;
                const m = d.getMinutes(); const r = m % round;
                return r===0 ? d : addMin(d, -r);
            };
            const fmt = (d) => `${d.getHours().toString().padStart(2,'0')}:${d.getMinutes().toString().padStart(2,'0')}`;

            let t = new Date(editingPlan.baseTime);

            // Forward
            stops[baseIdx].arrTime = t; 
            stops[baseIdx].depTime = roundUp(addMin(t, stops[baseIdx].stayTime));
            
            for(let i=baseIdx+1; i<stops.length; i++) {
                if(stops[i].type === 'STOP') {
                    const prevMove = stops[i-1];
                    const prevStop = stops[i-2];
                    const arr = addMin(prevStop.depTime, prevMove.duration || 0);
                    stops[i].arrTime = arr;
                    stops[i].depTime = roundUp(addMin(arr, stops[i].stayTime));
                }
            }

            // Backward
            t = stops[baseIdx].arrTime;
            for(let i=baseIdx-1; i>=0; i--) {
                if(stops[i].type === 'STOP') {
                    const nextMove = stops[i+1];
                    const nextStop = stops[i+2]; 
                    
                    if (nextMove.mode === 'WAIT') {
                        // ç‰¹æ®Š: å‡ºç™º(Index 2) -> é›†åˆ(Index 0) ã®é–“ã€‚ç§»å‹•æ™‚é–“0ã¨ã¿ãªã™ã€‚
                        stops[i].depTime = nextStop.arrTime; 
                        stops[i].arrTime = addMin(stops[i].depTime, -20); // é›†åˆã¯å‡ºç™ºã®20åˆ†å‰å›ºå®šã¨ã™ã‚‹
                    } else {
                        const depRaw = addMin(nextStop.arrTime, -(nextMove.duration||0));
                        stops[i].depTime = roundDown(depRaw);
                        stops[i].arrTime = addMin(stops[i].depTime, -stops[i].stayTime);
                    }
                }
            }

            stops.forEach(s => {
                if(s.type==='STOP') {
                    s.timeStr = fmt(s.arrTime);
                    s.depTimeStr = fmt(s.depTime);
                }
            });
        }

        // --- ãƒ˜ãƒ«ãƒ‘ãƒ¼ ---
        function initFullMap() {
            const div = document.getElementById('full-map-area'); if(!div) return;
            const map = new google.maps.Map(div, {zoom: 9, center: {lat:35.681, lng:139.767}, disableDefaultUI: true});
            const renderer = new google.maps.DirectionsRenderer({ map: map, suppressMarkers: false, polylineOptions:{strokeColor:'#4f46e5', strokeWeight:4} });
            
            // Index 2 (Start) ã‹ã‚‰ Last ã¾ã§ã‚’æç”»
            const pts = editingPlan.stops.slice(2).filter(s => s.type === 'STOP').map(s => ({ location: s.location, stopover: true }));
            if(pts.length < 2) return;
            
            const origin = pts[0].location;
            const dest = pts[pts.length-1].location;
            const waypoints = pts.slice(1, pts.length-1);

            new google.maps.DirectionsService().route({ origin: origin, destination: dest, waypoints: waypoints, travelMode: 'DRIVING' }, (res, status) => { if(status==='OK') renderer.setDirections(res); });
        }

        function updateDatalist() { const l=document.getElementById('saved-locations-list'); if(l) l.innerHTML=savedLocations.map(x=>`<option value="${x}">`).join(''); }
        function goHome() { if(mode==='EDIT' && !confirm('ç ´æ£„ã—ã¾ã™ã‹ï¼Ÿ')) return; renderDashboard(); }
        function saveCurrentPlan() {
            editingPlan.updatedAt = new Date().toISOString();
            const idx = savedPlans.findIndex(p => p.id === editingPlan.id);
            if(idx >= 0) savedPlans[idx] = editingPlan;
            else savedPlans.unshift(editingPlan);
            localStorage.setItem('savedPlans_v2', JSON.stringify(savedPlans));
            alert('ä¿å­˜ã—ã¾ã—ãŸ');
            renderDashboard();
        }
        function deletePlan(i) { if(!confirm('å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return; savedPlans.splice(i, 1); localStorage.setItem('savedPlans_v2', JSON.stringify(savedPlans)); renderDashboard(); }
        function openPlan(i) { editingPlan = savedPlans[i]; mode = 'RESULT'; renderTimeline(); }
        
        function checkUrlImport() {
            const p = new URLSearchParams(location.search);
            const d = p.get('d');
            if(d) {
                try {
                    const json = LZString.decompressFromEncodedURIComponent(d);
                    if(json) {
                        const plan = JSON.parse(json);
                        plan.id = 'import_'+Date.now();
                        savedPlans.unshift(plan);
                        localStorage.setItem('savedPlans_v2', JSON.stringify(savedPlans));
                        alert('å…±æœ‰ãƒ—ãƒ©ãƒ³ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ');
                        history.replaceState(null, '', location.pathname);
                    }
                } catch(e){}
            }
        }
        function sharePlan(i) {
            const plan = savedPlans[i];
            const cleanPlan = JSON.parse(JSON.stringify(plan));
            cleanPlan.stops.forEach(s => { delete s.arrTime; delete s.depTime; });
            const json = JSON.stringify(cleanPlan);
            const compressed = LZString.compressToEncodedURIComponent(json);
            const url = `${location.origin}${location.pathname}?d=${compressed}`;
            if(navigator.clipboard) navigator.clipboard.writeText(url).then(()=>alert('å…±æœ‰URLã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ'));
            else prompt('URLã‚’ã‚³ãƒ”ãƒ¼:', url);
        }
    </script>
</body>
</html>
