<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ—…ã®ã—ãŠã‚Šãƒ¡ãƒ¼ã‚«ãƒ¼ v1.0</title>
    <meta name="robots" content="noindex, nofollow">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lz-string/1.4.4/lz-string.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        
        /* ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ */
        .timeline-line { position: absolute; left: 19px; top: 35px; bottom: -20px; width: 2px; background-color: #e5e7eb; z-index: 0; }
        .timeline-item:last-child .timeline-line { display: none; }
        .timeline-dot { width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 18px; z-index: 10; position: relative; }
        
        /* ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .editable { border: 2px dashed #cbd5e1; background-color: #f8fafc; color: #64748b; cursor: pointer; transition: all 0.2s; }
        .editable:hover { border-color: #6366f1; color: #4f46e5; background-color: #eef2ff; }
        .filled { border: 2px solid #e0e7ff; background-color: #fff; color: #1e293b; }
        
        .modal-bg { background-color: rgba(0,0,0,0.5); }
    </style>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAOStiNglNEGEnPnhDxJG0RSQqgJXVtUQw&libraries=places,geometry&callback=initMap" async defer></script>
</head>
<body class="text-gray-800 pb-20">

    <header class="bg-indigo-700 text-white p-4 shadow-lg sticky top-0 z-40">
        <div class="max-w-2xl mx-auto flex justify-between items-center">
            <h1 class="text-xl font-bold flex items-center gap-2">
                <span>ğŸ“–</span> æ—…ã®ã—ãŠã‚Šãƒ¡ãƒ¼ã‚«ãƒ¼ <span class="text-xs bg-indigo-500 px-2 rounded">v1.0</span>
            </h1>
            <button onclick="resetApp()" class="text-xs text-indigo-200 hover:text-white">TOPã¸</button>
        </div>
    </header>

    <main id="app-content" class="max-w-2xl mx-auto p-4"></main>

    <div id="modal-location" class="hidden fixed inset-0 modal-bg z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-sm p-6">
            <h3 class="text-lg font-bold mb-4">ğŸ“ åœ°ç‚¹ãƒ»æ–½è¨­åã®å…¥åŠ›</h3>
            <input type="text" id="input-loc-name" class="w-full p-3 border rounded-lg text-lg font-bold mb-2" placeholder="ä¾‹: æ±äº¬é§…">
            <p id="loc-search-res" class="text-xs text-gray-500 mb-4 h-4">â€»ç¢ºå®šã‚’æŠ¼ã—ã¦ä½æ‰€ã‚’ç¢ºèªã—ã¦ãã ã•ã„</p>
            <div class="flex gap-2 mb-4">
                <button onclick="validateLocation()" class="flex-1 bg-indigo-100 text-indigo-700 font-bold py-2 rounded">ğŸ” ç¢ºå®šãƒ»æ¤œè¨¼</button>
            </div>
            <div class="flex justify-end gap-2">
                <button onclick="closeModal('modal-location')" class="px-4 py-2 text-gray-500">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button onclick="confirmLocation()" class="px-6 py-2 bg-indigo-600 text-white font-bold rounded-lg shadow">OK</button>
            </div>
        </div>
    </div>

    <div id="modal-transport" class="hidden fixed inset-0 modal-bg z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-sm p-6">
            <h3 class="text-lg font-bold mb-4">ğŸš— ç§»å‹•æ‰‹æ®µã®é¸æŠ</h3>
            <label class="block text-sm font-bold text-gray-500 mb-1">æ¬¡ã®åœ°ç‚¹ã¾ã§ã®ç§»å‹•</label>
            <select id="input-transport" class="w-full p-3 border rounded-lg text-lg font-bold mb-6">
                <option value="DRIVING_FREE">ğŸš™ è»Šï¼ˆç„¡æ–™å„ªå…ˆï¼‰</option>
                <option value="DRIVING_TOLL">ğŸï¸ è»Šï¼ˆæœ‰æ–™å„ªå…ˆï¼‰</option>
                <option value="TRANSIT">ğŸšƒ é›»è»Šãƒ»ãƒã‚¹</option>
                <option value="WALKING">ğŸš¶ å¾’æ­©</option>
                <option value="BICYCLING">ğŸš² è‡ªè»¢è»Š</option>
            </select>
            <div class="flex justify-end gap-2">
                <button onclick="closeModal('modal-transport')" class="px-4 py-2 text-gray-500">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button onclick="confirmTransport()" class="px-6 py-2 bg-indigo-600 text-white font-bold rounded-lg shadow">OK</button>
            </div>
        </div>
    </div>

    <div id="modal-stay" class="hidden fixed inset-0 modal-bg z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-sm p-6">
            <h3 class="text-lg font-bold mb-4">â³ æ»åœ¨è¨­å®š</h3>
            <div class="mb-3">
                <label class="block text-xs font-bold text-gray-500">æ»åœ¨ç†ç”±</label>
                <input type="text" id="input-stay-reason" class="w-full p-2 border rounded font-bold" placeholder="ä¾‹: æ˜¼é£Ÿ">
            </div>
            <div class="mb-3">
                <label class="block text-xs font-bold text-gray-500">æ»åœ¨æ™‚é–“</label>
                <select id="input-stay-time" class="w-full p-2 border rounded font-bold">
                    <option value="0">0åˆ† (é€šé)</option>
                    <option value="10">10åˆ†</option><option value="20">20åˆ†</option><option value="30">30åˆ†</option>
                    <option value="40">40åˆ†</option><option value="50">50åˆ†</option><option value="60">60åˆ†</option>
                    <option value="90">90åˆ†</option><option value="120">2æ™‚é–“</option><option value="180">3æ™‚é–“</option>
                    <option value="240">4æ™‚é–“</option><option value="300">5æ™‚é–“</option><option value="360">6æ™‚é–“</option>
                </select>
            </div>
            <div class="mb-4 bg-yellow-50 p-3 rounded border border-yellow-200">
                <label class="flex items-center gap-2 cursor-pointer">
                    <input type="checkbox" id="input-is-base" class="w-5 h-5 text-indigo-600">
                    <span class="font-bold text-sm text-yellow-800">â˜… ã“ã“ã‚’æ™‚é–“ã®åŸºç‚¹ã«ã™ã‚‹</span>
                </label>
            </div>
            <div class="flex justify-end gap-2">
                <button onclick="closeModal('modal-stay')" class="px-4 py-2 text-gray-500">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button onclick="confirmStay()" class="px-6 py-2 bg-indigo-600 text-white font-bold rounded-lg shadow">OK</button>
            </div>
        </div>
    </div>

    <div id="modal-memo" class="hidden fixed inset-0 modal-bg z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-sm p-6">
            <h3 class="text-lg font-bold mb-4">ğŸ“ ãƒ¡ãƒ¢å…¥åŠ›</h3>
            <textarea id="input-memo" rows="3" class="w-full p-3 border rounded-lg mb-4" placeholder="äºˆç´„ç•ªå·ã‚„æ³¨æ„äº‹é …ãªã©"></textarea>
            <div class="flex justify-end gap-2">
                <button onclick="closeModal('modal-memo')" class="px-4 py-2 text-gray-500">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button onclick="confirmMemo()" class="px-6 py-2 bg-indigo-600 text-white font-bold rounded-lg shadow">OK</button>
            </div>
        </div>
    </div>

    <div id="modal-finalize" class="hidden fixed inset-0 modal-bg z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-sm p-6">
            <h3 class="text-lg font-bold mb-4 text-indigo-700">ğŸš€ ã—ãŠã‚Šä½œæˆè¨­å®š</h3>
            <div class="mb-4">
                <label class="block text-xs font-bold text-gray-500 mb-1">ãƒ—ãƒ©ãƒ³å</label>
                <input type="text" id="final-plan-name" class="w-full p-2 border rounded font-bold" value="ãƒã‚¤æ—…ç¨‹ãƒ—ãƒ©ãƒ³">
            </div>
            <div class="mb-4">
                <label class="block text-xs font-bold text-gray-500 mb-1">åŸºç‚¹æ—¥æ™‚ï¼ˆå‡ºç™º/åˆ°ç€/é›†åˆï¼‰</label>
                <input type="datetime-local" id="final-base-time" class="w-full p-2 border rounded font-bold">
            </div>
            <div class="mb-6">
                <label class="block text-xs font-bold text-gray-500 mb-1">æ™‚é–“è¡¨ç¤ºåˆ‡ä¸Š</label>
                <select id="final-rounding" class="w-full p-2 border rounded">
                    <option value="0">ãªã—</option>
                    <option value="5">5åˆ†å˜ä½ (07â†’10)</option>
                    <option value="10">10åˆ†å˜ä½ (12â†’20)</option>
                </select>
            </div>
            <div class="flex justify-end gap-2">
                <button onclick="closeModal('modal-finalize')" class="px-4 py-2 text-gray-500">æˆ»ã‚‹</button>
                <button onclick="executeCalculation()" class="px-6 py-2 bg-gradient-to-r from-indigo-600 to-purple-600 text-white font-bold rounded-lg shadow-lg">ä½œæˆã™ã‚‹ï¼</button>
            </div>
        </div>
    </div>

    <script>
        // --- çŠ¶æ…‹ç®¡ç† ---
        let mode = 'LANDING'; // LANDING, EDIT, RESULT
        let stops = [];
        let editingIndex = -1; // ç¾åœ¨ãƒ¢ãƒ¼ãƒ€ãƒ«ã§ç·¨é›†ä¸­ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
        let tempLocationData = null; // æ¤œè¨¼æ¸ˆã¿ã®ä¸€æ™‚ãƒ‡ãƒ¼ã‚¿

        // åˆæœŸåŒ–
        function initMap() { console.log("API Ready"); }
        window.onload = () => renderLanding();

        // 1. ãƒ©ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ãƒšãƒ¼ã‚¸ï¼ˆå®Œæˆè¦‹æœ¬ï¼‰
        function renderLanding() {
            mode = 'LANDING';
            const html = `
                <div class="bg-white rounded-3xl shadow-xl overflow-hidden mb-8">
                    <div class="p-6 bg-gradient-to-r from-blue-600 to-indigo-700 text-white text-center">
                        <h2 class="text-2xl font-extrabold mb-1">æ±äº¬è¦³å…‰ãƒ—ãƒ©ãƒ³</h2>
                        <p class="text-sm opacity-80">2025/05/01 ä½œæˆ</p>
                    </div>
                    <div class="p-6 space-y-6">
                        ${renderSampleRow(1, '09:50', 'æ±äº¬é§… é›†åˆ', 'point', true)}
                        ${renderSampleRow(1, '10:00', 'æ±äº¬é§… å‡ºç™º', 'point')}
                        ${renderSampleMove('è»Š(æœ‰æ–™)ç§»å‹•', '30åˆ†', 'é¦–éƒ½é«˜é€Ÿéƒ½å¿ƒç’°çŠ¶ç·š')}
                        ${renderSampleRow(2, '10:30', 'æµ…è‰å¯º åˆ°ç€', 'point', true)}
                        ${renderSampleStay('è¦³å…‰', '60åˆ†', 'ä»²è¦‹ä¸–é€šã‚Šã§ãŠåœŸç”£')}
                        ${renderSampleRow(2, '11:30', 'æµ…è‰å¯º å‡ºç™º', 'point')}
                        ${renderSampleMove('å¾’æ­©ç§»å‹•', '15åˆ†', '')}
                        ${renderSampleRow(3, '11:45', 'æ±äº¬ã‚¹ã‚«ã‚¤ãƒ„ãƒªãƒ¼ åˆ°ç€', 'point', true)}
                        ${renderSampleStay('å±•æœ›å°ãƒ»æ˜¼é£Ÿ', '90åˆ†', '12:00ã«äºˆç´„æ¸ˆã¿')}
                        <div class="pt-8 text-center">
                            <button onclick="startEditing()" class="w-full py-4 bg-gradient-to-r from-pink-500 to-rose-500 text-white text-xl font-extrabold rounded-2xl shadow-xl hover:scale-105 transition transform">
                                + æ–°ã—ããƒã‚¤ã€Œæ—…ã®ã—ãŠã‚Šã€ã‚’ã¤ãã‚‹
                            </button>
                        </div>
                    </div>
                </div>
            `;
            document.getElementById('app-content').innerHTML = html;
        }

        // è¦‹æœ¬ç”¨ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°é–¢æ•°
        function renderSampleRow(idx, time, title, type, highlight=false) {
            const dot = type==='point' ? 'ğŸ“' : 'â³';
            const bg = highlight ? 'bg-indigo-600 text-white shadow-lg' : 'bg-white border-2 border-gray-200 text-gray-400';
            return `<div class="relative pl-8 pb-4">
                <div class="timeline-line"></div>
                <div class="absolute left-0 top-0 w-10 h-10 ${bg} rounded-full flex items-center justify-center font-bold z-10">${dot}</div>
                <div class="flex items-baseline gap-4 pt-1">
                    <div class="w-14 text-right font-bold text-lg text-indigo-900">${time}</div>
                    <div class="font-bold text-lg text-gray-800">${title}</div>
                </div>
            </div>`;
        }
        function renderSampleStay(reason, time, memo) {
            return `<div class="relative pl-8 pb-4">
                <div class="timeline-line"></div>
                <div class="flex items-start gap-4 pt-1">
                    <div class="w-14"></div>
                    <div class="bg-yellow-50 p-3 rounded-lg w-full border border-yellow-100">
                        <div class="font-bold text-gray-800">${reason} <span class="text-sm font-normal text-gray-500 ml-2">æ»åœ¨ ${time}</span></div>
                        <div class="text-sm text-gray-600 mt-1">ğŸ“ ${memo}</div>
                    </div>
                </div>
            </div>`;
        }
        function renderSampleMove(mode, time, road) {
            return `<div class="relative pl-8 pb-4">
                <div class="timeline-line"></div>
                <div class="flex items-center gap-4 pt-1">
                    <div class="w-14 text-right text-xs text-gray-400">${time}</div>
                    <div class="text-sm text-gray-500 flex flex-col">
                        <span>ğŸš— ${mode}</span>
                        ${road ? `<span class="text-xs bg-gray-100 px-1 rounded mt-1">${road}</span>` : ''}
                    </div>
                </div>
            </div>`;
        }

        // 2. ç·¨é›†ãƒ¢ãƒ¼ãƒ‰é–‹å§‹
        function startEditing() {
            mode = 'EDIT';
            // åˆæœŸãƒ‡ãƒ¼ã‚¿ç”Ÿæˆ (4åœ°ç‚¹ã€3ç•ªç›®åŸºç‚¹)
            stops = [
                { type:'STOP', name:'', location:'', confirmed:false, stayTime:0, stayReason:'', memo:'' },
                { type:'MOVE', mode:'DRIVING_FREE' },
                { type:'STOP', name:'', location:'', confirmed:false, stayTime:10, stayReason:'', memo:'' },
                { type:'MOVE', mode:'DRIVING_FREE' },
                { type:'STOP', name:'', location:'', confirmed:false, stayTime:60, stayReason:'æ˜¼é£Ÿ', memo:'', isBase:true }, // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆåŸºç‚¹
                { type:'MOVE', mode:'DRIVING_FREE' },
                { type:'STOP', name:'', location:'', confirmed:false, stayTime:0, stayReason:'', memo:'' }
            ];
            renderEditor();
        }

        // ç·¨é›†ç”»é¢ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚° (WYSIWYG)
        function renderEditor() {
            let html = `<div class="bg-white rounded-3xl shadow-xl p-6 space-y-6">`;
            
            stops.forEach((item, i) => {
                if (item.type === 'STOP') {
                    // åœ°ç‚¹è¡Œ
                    const isFirst = i===0;
                    const isLast = i===stops.length-1;
                    const titleSuffix = isFirst ? 'é›†åˆ/å‡ºç™º' : isLast ? 'åˆ°ç€/è§£æ•£' : 'åˆ°ç€';
                    const nameBtn = item.name ? 
                        `<button onclick="openLocationModal(${i})" class="filled px-4 py-2 rounded-lg font-bold text-lg w-full text-left">${item.name} ${titleSuffix}</button>` :
                        `<button onclick="openLocationModal(${i})" class="editable px-4 py-2 rounded-lg font-bold text-lg w-full text-left border-dashed border-2">ï¼‹ åœ°ç‚¹ãƒ»æ–½è¨­åã‚’å…¥åŠ›</button>`;
                    
                    html += `<div class="relative pl-8 pb-2">
                        <div class="timeline-line"></div>
                        <div class="absolute left-0 top-0 w-10 h-10 ${item.isBase ? 'bg-red-500 text-white' : 'bg-white border-2 border-gray-300'} rounded-full flex items-center justify-center font-bold z-10 shadow-sm">
                            ${item.isBase ? 'â˜…' : i/2+1}
                        </div>
                        <div class="flex gap-2 items-center">
                            <div class="w-14 text-right font-bold text-gray-300 text-lg">00:00</div>
                            <div class="flex-1">${nameBtn}</div>
                            <div class="flex flex-col gap-1">
                                <button onclick="moveStop(${i}, -1)" class="text-xs bg-gray-100 p-1 rounded hover:bg-gray-200">â†‘</button>
                                <button onclick="moveStop(${i}, 1)" class="text-xs bg-gray-100 p-1 rounded hover:bg-gray-200">â†“</button>
                            </div>
                            ${(!isFirst && !isLast) ? `<button onclick="deleteStop(${i})" class="text-red-300 hover:text-red-500 ml-1">Ã—</button>` : ''}
                        </div>`;

                    // æ»åœ¨è¡Œ (å‡ºç™ºãƒ»åˆ°ç€ä»¥å¤–)
                    if (!isFirst && !isLast) {
                        const stayBtn = (item.stayReason || item.stayTime > 0) ?
                            `<div class="font-bold">${item.stayReason||'æ»åœ¨'} <span class="text-sm font-normal ml-2">${item.stayTime}åˆ†</span></div>` :
                            `<div class="text-gray-400">ï¼‹ æ»åœ¨ç†ç”±ãƒ»æ™‚é–“ã‚’å…¥åŠ›</div>`;
                        const memoBtn = item.memo ? `<div class="text-xs text-gray-600 mt-1">ğŸ“ ${item.memo}</div>` : `<div class="text-xs text-gray-300 mt-1">ï¼‹ ãƒ¡ãƒ¢ã‚’å…¥åŠ›</div>`;

                        html += `<div class="flex gap-2 mt-2 ml-16">
                            <div class="flex-1 bg-yellow-50 rounded-lg p-2 border border-yellow-100 cursor-pointer hover:bg-yellow-100 transition" onclick="openStayModal(${i})">
                                ${stayBtn}
                            </div>
                            <div class="flex-1 bg-gray-50 rounded-lg p-2 border border-gray-100 cursor-pointer hover:bg-gray-100 transition" onclick="openMemoModal(${i})">
                                ${memoBtn}
                            </div>
                        </div>`;
                    }
                    html += `</div>`; // Close row

                } else if (item.type === 'MOVE') {
                    // ç§»å‹•è¡Œ
                    const modeLabels = { 'DRIVING_FREE':'ğŸš™ è»Š(ç„¡æ–™)', 'DRIVING_TOLL':'ğŸï¸ è»Š(æœ‰æ–™)', 'TRANSIT':'ğŸšƒ é›»è»Š', 'WALKING':'ğŸš¶ å¾’æ­©', 'BICYCLING':'ğŸš² è‡ªè»¢è»Š' };
                    html += `<div class="relative pl-8 pb-4 pt-2">
                        <div class="timeline-line"></div>
                        <div class="flex gap-2 items-center ml-16">
                            <button onclick="openTransportModal(${i})" class="px-3 py-1 rounded-full text-sm font-bold bg-blue-50 text-blue-600 border border-blue-100 hover:bg-blue-100 transition">
                                ${modeLabels[item.mode]} â–¼
                            </button>
                            <span class="text-xs text-gray-400">00åˆ†</span>
                        </div>
                    </div>`;
                }
            });

            html += `
                <div class="pt-6 space-y-4">
                    <button onclick="addNewStop()" class="w-full py-3 border-2 border-dashed border-gray-300 text-gray-500 font-bold rounded-xl hover:text-indigo-500 hover:border-indigo-500 transition">
                        ï¼‹ åœ°ç‚¹ã‚’è¿½åŠ ã™ã‚‹
                    </button>
                    <button onclick="openFinalizeModal()" class="w-full py-4 bg-gradient-to-r from-indigo-600 to-purple-600 text-white text-xl font-extrabold rounded-2xl shadow-xl hover:opacity-90 transition transform hover:-translate-y-1">
                        âœ¨ æ—…ã®ã—ãŠã‚Šã‚’ã¤ãã‚‹
                    </button>
                </div>
            </div>`;
            document.getElementById('app-content').innerHTML = html;
        }

        // --- ãƒ¢ãƒ¼ãƒ€ãƒ«åˆ¶å¾¡ ---
        function openModal(id) { document.getElementById(id).classList.remove('hidden'); }
        function closeModal(id) { document.getElementById(id).classList.add('hidden'); }

        // 1. åœ°ç‚¹ãƒ¢ãƒ¼ãƒ€ãƒ«
        function openLocationModal(idx) {
            editingIndex = idx;
            const item = stops[idx];
            document.getElementById('input-loc-name').value = item.name;
            document.getElementById('loc-search-res').innerHTML = item.confirmed ? 
                `<span class="text-green-600">âœ… ç¢ºå®šæ¸ˆ: ${item.location}</span>` : 'â€»ç¢ºå®šã‚’æŠ¼ã—ã¦ä½æ‰€ã‚’ç¢ºèªã—ã¦ãã ã•ã„';
            tempLocationData = item.confirmed ? item.location : null;
            openModal('modal-location');
        }
        function validateLocation() {
            const val = document.getElementById('input-loc-name').value;
            if(!val) return;
            const svc = new google.maps.places.AutocompleteService();
            svc.getPlacePredictions({ input: val }, (preds, status) => {
                const res = document.getElementById('loc-search-res');
                if (status === 'OK' && preds.length > 0) {
                    tempLocationData = preds[0].description;
                    res.innerHTML = `<span class="text-green-600">âœ… OK: ${tempLocationData}</span>`;
                } else {
                    tempLocationData = null;
                    res.innerHTML = `<span class="text-red-500">âŒ è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚æ­£å¼åç§°ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚</span>`;
                }
            });
        }
        function confirmLocation() {
            const val = document.getElementById('input-loc-name').value;
            if (!tempLocationData) { alert('ä½æ‰€ã®ç¢ºå®šã‚’è¡Œã£ã¦ãã ã•ã„'); return; }
            stops[editingIndex].name = val;
            stops[editingIndex].location = tempLocationData;
            stops[editingIndex].confirmed = true;
            closeModal('modal-location');
            renderEditor();
        }

        // 2. ç§»å‹•ãƒ¢ãƒ¼ãƒ€ãƒ«
        function openTransportModal(idx) {
            editingIndex = idx;
            document.getElementById('input-transport').value = stops[idx].mode;
            openModal('modal-transport');
        }
        function confirmTransport() {
            stops[editingIndex].mode = document.getElementById('input-transport').value;
            closeModal('modal-transport');
            renderEditor();
        }

        // 3. æ»åœ¨ãƒ¢ãƒ¼ãƒ€ãƒ«
        function openStayModal(idx) {
            editingIndex = idx;
            document.getElementById('input-stay-reason').value = stops[idx].stayReason;
            document.getElementById('input-stay-time').value = stops[idx].stayTime;
            document.getElementById('input-is-base').checked = stops[idx].isBase || false;
            openModal('modal-stay');
        }
        function confirmStay() {
            stops[editingIndex].stayReason = document.getElementById('input-stay-reason').value;
            stops[editingIndex].stayTime = parseInt(document.getElementById('input-stay-time').value);
            // åŸºç‚¹ãƒªã‚»ãƒƒãƒˆï¼†ã‚»ãƒƒãƒˆ
            if(document.getElementById('input-is-base').checked) {
                stops.forEach(s => { if(s.type==='STOP') s.isBase = false; });
                stops[editingIndex].isBase = true;
            }
            closeModal('modal-stay');
            renderEditor();
        }

        // 4. ãƒ¡ãƒ¢ãƒ¢ãƒ¼ãƒ€ãƒ«
        function openMemoModal(idx) {
            editingIndex = idx;
            document.getElementById('input-memo').value = stops[idx].memo;
            openModal('modal-memo');
        }
        function confirmMemo() {
            stops[editingIndex].memo = document.getElementById('input-memo').value;
            closeModal('modal-memo');
            renderEditor();
        }

        // ç·¨é›†æ©Ÿèƒ½
        function addNewStop() {
            stops.push({ type:'MOVE', mode:'DRIVING_FREE' });
            stops.push({ type:'STOP', name:'', location:'', confirmed:false, stayTime:10, stayReason:'', memo:'' });
            renderEditor();
        }
        function deleteStop(idx) {
            if(!confirm('å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
            // å‰å¾Œã®MOVEã‚‚å«ã‚ã¦å‰Šé™¤èª¿æ•´ãŒå¿…è¦
            // å˜ç´”åŒ–ã®ãŸã‚ã€idxã¨idx-1(MOVE)ã‚’å‰Šé™¤ã™ã‚‹ãŒã€å…ˆé ­/æœ«å°¾ã®å ´åˆã®è€ƒæ…®ãŒå¿…è¦
            if (idx > 0) {
                stops.splice(idx - 1, 2); // MOVEã¨STOPã‚’å‰Šé™¤
            } else {
                stops.splice(0, 2); // å…ˆé ­ã®å ´åˆã€è‡ªåˆ†ã¨å¾Œã‚ã®MOVEã‚’å‰Šé™¤
            }
            renderEditor();
        }
        function moveStop(idx, dir) {
            // STOP - MOVE - STOP ã®ã‚»ãƒƒãƒˆã§ç§»å‹•ã•ã›ã‚‹å¿…è¦ãŒã‚ã‚‹ãŸã‚å°‘ã—è¤‡é›‘
            // ä»Šå›ã¯ç°¡æ˜“çš„ã«å®Ÿè£…ã›ãšã€è¿½åŠ ãƒ»å‰Šé™¤ã§å¯¾å¿œã—ã¦ã‚‚ã‚‰ã†ã‹ã€å¾Œã»ã©å®Ÿè£…
            alert('ä¸¦ã³æ›¿ãˆã¯ç¾åœ¨é–‹ç™ºä¸­ã§ã™ã€‚å‰Šé™¤ã¨è¿½åŠ ã§èª¿æ•´ã—ã¦ãã ã•ã„ã€‚');
        }

        // 5. æœ€çµ‚ä½œæˆ
        function openFinalizeModal() {
            // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
            const invalid = stops.filter(s => s.type==='STOP' && !s.confirmed);
            if (invalid.length > 0) {
                alert('æœªç¢ºå®šã®åœ°ç‚¹ãŒã‚ã‚Šã¾ã™ã€‚å…¨ã¦ã®åœ°ç‚¹ã§ã€Œç¢ºå®šã€ã‚’è¡Œã£ã¦ãã ã•ã„ã€‚');
                return;
            }
            // åŸºç‚¹æ—¥æ™‚ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼ˆç¿Œæ—¥12:00ï¼‰
            const now = new Date(); now.setDate(now.getDate()+1); now.setHours(12,0,0,0);
            const iso = new Date(now.getTime() - now.getTimezoneOffset()*60000).toISOString().slice(0,16);
            document.getElementById('final-base-time').value = iso;
            openModal('modal-finalize');
        }

        async function executeCalculation() {
            const planName = document.getElementById('final-plan-name').value;
            const baseTime = document.getElementById('final-base-time').value;
            const rounding = parseInt(document.getElementById('final-rounding').value);
            
            closeModal('modal-finalize');
            document.getElementById('app-content').innerHTML = '<div class="text-center p-20"><div class="text-2xl font-bold animate-pulse">ğŸš€ ãƒ«ãƒ¼ãƒˆè¨ˆç®—ä¸­...</div><p class="text-gray-500">Google Maps APIã¨é€šä¿¡ã—ã¦ã„ã¾ã™</p></div>';

            // ãƒ«ãƒ¼ãƒˆè¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯
            const ds = new google.maps.DirectionsService();
            const segments = [];
            
            // stopsé…åˆ—ã‹ã‚‰MOVEéƒ¨åˆ†ã‚’æŠ½å‡ºã—ã¦è¨ˆç®—
            for (let i = 0; i < stops.length; i++) {
                if (stops[i].type === 'MOVE') {
                    const start = stops[i-1].location;
                    const end = stops[i+1].location;
                    const modeFull = stops[i].mode; // DRIVING_FREE, DRIVING_TOLL, TRANSIT...
                    
                    let gMode = 'DRIVING';
                    let avoidTolls = false;
                    
                    if (modeFull === 'DRIVING_FREE') { avoidTolls = true; }
                    else if (modeFull === 'DRIVING_TOLL') { avoidTolls = false; }
                    else { gMode = modeFull; } // TRANSIT, WALKING...

                    try {
                        const result = await new Promise((resolve, reject) => {
                            ds.route({
                                origin: start, destination: end,
                                travelMode: gMode,
                                avoidTolls: avoidTolls,
                            }, (res, status) => {
                                if (status === 'OK') resolve(res.routes[0]); // ãƒ™ã‚¹ãƒˆãƒ«ãƒ¼ãƒˆï¼ˆ0ç•ªç›®ï¼‰ã‚’æ¡ç”¨
                                else resolve(null);
                            });
                        });
                        
                        if (result) {
                            const leg = result.legs[0];
                            const duration = Math.ceil(leg.duration.value / 60);
                            let roads = [];
                            if (gMode === 'DRIVING') {
                                leg.steps.forEach(s => {
                                    if(s.instructions.includes('æœ‰æ–™') || s.instructions.includes('é«˜é€Ÿ')) {
                                        // ç°¡æ˜“æŠ½å‡º
                                        const m = s.instructions.match(/([^\s]+(?:é«˜é€Ÿ|è‡ªå‹•è»Šé“|ãƒ©ã‚¤ãƒ³)[^\s]*)/);
                                        if(m) roads.push(m[1]);
                                    }
                                });
                                // é‡è¤‡æ’é™¤
                                roads = [...new Set(roads)];
                            }
                            stops[i].duration = duration;
                            stops[i].distance = leg.distance.text;
                            stops[i].roads = roads;
                        } else {
                            stops[i].duration = 0; // è¨ˆç®—å¤±æ•—
                        }
                    } catch(e) {
                        stops[i].duration = 0;
                    }
                }
            }

            // æ™‚é–“è¨ˆç®—ã¨æç”»
            renderResult(planName, baseTime, rounding);
        }

        function renderResult(planName, baseTime, rounding) {
            mode = 'RESULT';
            // ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«è¨ˆç®—
            const baseIdx = stops.findIndex(s => s.isBase);
            let t = new Date(baseTime);
            
            // Helper
            const addMin = (d, m) => new Date(d.getTime() + m*60000);
            const roundTime = (d, unit) => {
                if(!unit) return d;
                const m = d.getMinutes();
                const rem = m % unit;
                if(rem===0) return d;
                return addMin(d, unit - rem);
            };
            const fmt = (d) => `${d.getHours().toString().padStart(2,'0')}:${d.getMinutes().toString().padStart(2,'0')}`;

            // Forward
            for(let i=baseIdx; i<stops.length; i++) {
                if(stops[i].type==='STOP') {
                    stops[i].arrTime = t;
                    stops[i].depTime = roundTime(addMin(t, stops[i].stayTime), rounding);
                } else {
                    t = addMin(stops[i-1].depTime, stops[i].duration || 30);
                }
            }
            // Backward
            t = stops[baseIdx].arrTime;
            for(let i=baseIdx-1; i>=0; i--) {
                if(stops[i].type==='MOVE') {
                    t = addMin(t, -(stops[i].duration || 30));
                } else {
                    stops[i].depTime = t; // æ¬¡ã®åˆ°ç€æ™‚åˆ»ã‹ã‚‰é€†ç®—ã—ãŸå‡ºç™ºæ™‚åˆ»ï¼ˆä¸¸ã‚å‰ï¼‰
                    // å®Ÿéš›ã¯ã“ã“ã‚‚ä¸¸ã‚ãƒ­ã‚¸ãƒƒã‚¯ãŒå¿…è¦ã ãŒç°¡æ˜“åŒ–: å‡ºç™º = æ¬¡åˆ°ç€ - ç§»å‹•
                    // åˆ°ç€ = å‡ºç™º - æ»åœ¨
                    stops[i].arrTime = addMin(t, -stops[i].stayTime);
                    t = stops[i].arrTime;
                }
            }

            // HTMLç”Ÿæˆ
            let html = `
                <div class="bg-white rounded-3xl shadow-xl overflow-hidden mb-8">
                    <div class="p-6 bg-gradient-to-r from-indigo-600 to-purple-600 text-white text-center">
                        <h2 class="text-2xl font-extrabold mb-1">${planName}</h2>
                        <p class="text-sm opacity-80">${new Date().toLocaleDateString()} ä½œæˆ</p>
                    </div>
                    <div class="p-6 space-y-6">`;

            stops.forEach((item, i) => {
                if (item.type === 'STOP') {
                    const isFirst = i===0; const isLast = i===stops.length-1;
                    if(isFirst) {
                        html += renderSampleRow(i, fmt(item.depTime), `${item.name} å‡ºç™º`, 'point');
                    } else if(isLast) {
                        html += renderSampleRow(i, fmt(item.arrTime), `${item.name} åˆ°ç€`, 'point', true);
                    } else {
                        html += renderSampleRow(i, fmt(item.arrTime), `${item.name} åˆ°ç€`, 'point', true);
                        html += renderSampleStay(item.stayReason||'æ»åœ¨', `${item.stayTime}åˆ†`, item.memo||'');
                        html += renderSampleRow(i, fmt(item.depTime), `${item.name} å‡ºç™º`, 'point');
                    }
                } else {
                    const roadTxt = item.roads && item.roads.length>0 ? item.roads.join(', ') : (item.mode.includes('FREE')?'ä¸‹é“å„ªå…ˆ':'');
                    const modeName = {'DRIVING_FREE':'è»Š','DRIVING_TOLL':'è»Š','TRANSIT':'é›»è»Š','WALKING':'å¾’æ­©','BICYCLING':'è‡ªè»¢è»Š'}[item.mode] || 'ç§»å‹•';
                    html += renderSampleMove(`${modeName}ç§»å‹•`, `${item.duration}åˆ†`, roadTxt);
                }
            });

            html += `   <div class="pt-8 text-center flex gap-4">
                            <button onclick="startEditing()" class="flex-1 py-3 bg-gray-200 text-gray-700 font-bold rounded-xl hover:bg-gray-300">ä¿®æ­£ã™ã‚‹</button>
                            <button onclick="window.print()" class="flex-1 py-3 bg-indigo-600 text-white font-bold rounded-xl shadow hover:bg-indigo-700">å°åˆ· / PDFä¿å­˜</button>
                        </div>
                    </div>
                </div>`;
            
            document.getElementById('app-content').innerHTML = html;
        }

        function resetApp() {
            if(confirm('ãƒˆãƒƒãƒ—ç”»é¢ã«æˆ»ã‚Šã¾ã™ã‹ï¼Ÿå…¥åŠ›ä¸­ã®ãƒ‡ãƒ¼ã‚¿ã¯æ¶ˆãˆã¾ã™ã€‚')) renderLanding();
        }

    </script>
</body>
</html>
